# /home/icculus/infra/logging/config/fluent-bit/fluent-bit.conf
#
# Corrected AGAIN to remove inline comments because the parser is a sensitive little bitch.
# This should be the one.
#

[SERVICE]
    # This is the most important setting for debugging.
    Log_Level    info
    # Flush logs every second so we see them immediately.
    Flush        1
    Daemon       Off
    Parsers_File parsers.conf

[INPUT]
    # This is the front door. It receives logs from the Docker Daemon.
    Name              forward
    Listen            0.0.0.0
    Port              24224
    # The Tag_Prefix is used to match against filters and outputs.
    Tag_Prefix        axiom.

# ---------------------------------------------------------------------------------
# FILTER 1: Tell Fluent Bit how to interpret Docker's metadata.
# This makes sure the container_name, etc., are top-level fields.
# ---------------------------------------------------------------------------------
[FILTER]
    Name          parser
    Match         axiom.*
    Key_Name      log
    Parser        docker
    # Keep the original raw log field after parsing.
    Reserve_Data  True
    # Keep the original Docker key/value pairs.
    Preserve_Key  True

# ---------------------------------------------------------------------------------
# FILTER 2: Lift nested JSON fields up.
# If your log message is a JSON string (like from structlog), this unpacks it.
# ---------------------------------------------------------------------------------
[FILTER]
    Name          parser
    Match         axiom.*
    Key_Name      log
    Parser        json
    # Keep the original log message just in case parsing fails.
    Reserve_Data  True

# ---------------------------------------------------------------------------------
# OUTPUT 1: The 'stdout' block for debugging. UNCOMMENT THIS to see raw data flow.
# This prints every single record that Fluent Bit processes to its own logs.
# It proves that data is GETTING IN.
# ---------------------------------------------------------------------------------
# [OUTPUT]
#     Name    stdout
#     Match   *

# ---------------------------------------------------------------------------------
# OUTPUT 2: The final destination.
# This sends all matched records to your secured Elasticsearch with SSL.
# ---------------------------------------------------------------------------------
[OUTPUT]
    Name                  es
    Match                 axiom.*
    Host                  ${ELASTICSEARCH_HOST}
    Port                  ${ELASTICSEARCH_PORT}
    Index                 axiom-flow-%Y.%m.%d
    # This is required for Elasticsearch 7+ to avoid type mapping issues.
    Suppress_Type_Name    On

    # --- SSL/TLS SETTINGS ---
    tls                   On
    tls.verify            On
    tls.ca_file           /fluent-bit/etc/certs/ca/ca.crt
    
    # --- AUTHENTICATION ---
    HTTP_User             elastic
    HTTP_Passwd           ${ELASTICSEARCH_PASSWORD}

    # --- ERROR HANDLING ---
    # Retry sending a chunk of logs for up to 20 times.
    # If it still fails, drop the data so we don't block the whole pipeline.
    Retry_Limit           20
